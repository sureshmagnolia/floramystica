<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flora Mystica: The Magical Path</title>

    <style>
        body { font-family: 'Georgia', serif; background-color: #f0f8ff; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; box-sizing: border-box; }
        .game-container { background-color: #ffffff; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 95%; max-width: 600px; text-align: center; position: relative; }
        #score-display { background-color: #eaf5ff; color: #2e8b57; padding: 5px 15px; border-radius: 20px; font-size: 1.2em; font-weight: bold; margin: -10px auto 15px auto; display: inline-block; }
        h1 { color: #2e8b57; margin-top: 0; margin-bottom: 20px; font-size: 1.8em; }
        .riddle-text, .feedback-text { margin: 20px 0; line-height: 1.6; font-size: 1.1em; min-height: 20px; }
        .story-text { margin: 20px 0; line-height: 1.6; font-size: 1.1em; min-height: 20px; max-height: 40vh; overflow-y: auto; padding-right: 15px; text-align: left; }
        .story-text h3 { color: #3cb371; margin-bottom: 5px; }
        .story-text p { margin-top: 0; }
        .riddle-text { white-space: pre-wrap; text-align: left; padding: 15px; background-color: #fafafa; border-left: 4px solid #3cb371; border-radius: 5px; }
        #game-controls { margin-top: 25px; }
        .autocomplete-container { position: relative; display: inline-block; width: 70%; }
        .instruction-text { font-size: 0.9em; font-style: italic; color: #555; margin-bottom: 8px; }
        #answer-input { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; }
        .autocomplete-items { position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background-color: #fff; }
        .autocomplete-items div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #d4d4d4; text-align: left; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
        #submit-button, .control-button { padding: 12px 20px; border: none; background-color: #2e8b57; color: white; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; vertical-align: top; margin: 5px; }
        #submit-button:hover, .control-button:hover { background-color: #3cb371; }
        .feedback-text { font-style: italic; font-weight: bold; }
        .feedback-correct { color: #2e8b57; }
        .feedback-incorrect { color: #d9534f; }
        @media (max-width: 520px) { .autocomplete-container, #submit-button, .control-button { width: 100%; margin-left: 0; margin-right: 0; } }
        @media (max-height: 750px) { .riddle-text { max-height: 20vh; overflow-y: auto; } }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Flora Mystica: The Magical Path</h1>
        <div id="score-display">Score: 0</div>
        <div id="story-area" class="story-text">Loading game data...</div>
        <div id="riddle-area" class="riddle-text" style="display:none;"></div>
        <div id="game-controls">
            <div id="autocomplete-container" class="autocomplete-container" style="display:none;">
                <p class="instruction-text">Identify the botanical Family name below.</p>
                <input type="text" id="answer-input" placeholder="Type 3 letters of the Family name...">
                <div id="autocomplete-results" class="autocomplete-items"></div>
            </div>
            <div id="start-screen-controls"></div>
            <button id="submit-button" style="display:none;">Submit Answer</button>
        </div>
        <div id="feedback-area" class="feedback-text"></div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwdMk_TwMcs6coyMyBad-ChWJ7nwfhxOBYo6q6qndJlf2l6yhd7WWG1aAqsgFxiAnpEFw/exec';
        let currentLevel = 1, isGameActive = true, score = 0, plantFamilies = [];
        const praiseMessages = ["Brilliant! ‚ú® You're a natural botanist!", "Amazing! üåø The Grand Tree feels stronger already!", "Incredible! üå∏ Your wisdom shines bright!", "Excellent work! üå≥ The shadow recedes!", "Perfect! üåü You've mastered that riddle!"];
        
        const scoreDisplay = document.getElementById('score-display'), storyArea = document.getElementById('story-area'), riddleArea = document.getElementById('riddle-area'), autocompleteContainer = document.getElementById('autocomplete-container'), answerInput = document.getElementById('answer-input'), autocompleteResults = document.getElementById('autocomplete-results'), startScreenControls = document.getElementById('start-screen-controls'), submitButton = document.getElementById('submit-button'), feedbackArea = document.getElementById('feedback-area');

        function updateScore(newScore) { score = newScore; scoreDisplay.textContent = `Score: ${score}`; localStorage.setItem('floraMysticaScore', score); }

        document.addEventListener('DOMContentLoaded', () => {
            const script = document.createElement('script');
            script.src = `${WEB_APP_URL}?list=families&callback=onFamiliesLoaded`;
            document.body.appendChild(script);
            script.onerror = () => {
                console.error("Failed to load plant families script.");
                storyArea.innerHTML = "<h3>Error</h3><p>Could not load essential game data. Please check your internet connection and refresh.</p>";
            };
        });

        function onFamiliesLoaded(data) {
            plantFamilies = data;
            initializeGameUI();
        }

        function initializeGameUI() {
            const savedLevel = localStorage.getItem('floraMysticaLevel'), savedScore = localStorage.getItem('floraMysticaScore');
            if (savedScore) { score = parseInt(savedScore, 10) || 0; scoreDisplay.textContent = `Score: ${score}`; }

            if (savedLevel && parseInt(savedLevel, 10) > 1) {
                currentLevel = parseInt(savedLevel, 10);
                storyArea.innerHTML = `<h3>Welcome Back, Adventurer!</h3><p>Your quest awaits at Level ${currentLevel}.</p>`;
                startScreenControls.innerHTML = `<button id="continue-button" class="control-button">Continue Quest</button><button id="restart-button" class="control-button">Start New Quest</button>`;
                document.getElementById('continue-button').addEventListener('click', () => startGame(false));
                document.getElementById('restart-button').addEventListener('click', () => startGame(true));
            } else {
                showMainStory();
                startScreenControls.innerHTML = `<button id="start-button" class="control-button">I'm Ready for the Quest!</button>`;
                document.getElementById('start-button').addEventListener('click', () => startGame(true));
            }
        }
        
        function showMainStory() {
            let storyHTML = '<h3>The Garden Kingdom</h3><p>In a land far removed from the mundanities of our world exists the Garden Kingdom‚Äîa realm governed not by kings or queens, but by the flora that roots itself deeply into the very soul of the land. Here, every flower, tree, and herb holds mystical properties, and their harmonious existence ensures the kingdom remains a utopia of enchanting meadows, mystical forests, and mesmerizing gardens.</p><h3>The Grand Tree of Lore</h3><p>At the heart of this realm stands the Grand Tree of Lore, a colossal tree with foliage that glistens like emeralds under the eternal sunlight. It\'s the keeper of ancient wisdom, the sustainer of life, and the epitome of unity among all flora.</p><h3>A Shadow Falls</h3><p>But not all is well in this verdant paradise. A dark, formless shadow has slowly begun to creep across the kingdom, suffocating the lesser flora and draining them of their mystical essence. Its once-luminous leaves have dulled, and the symphony of whispers that once filled the air around it has descended into agonized groans.</p><h3>The Quest for the Petals of Power</h3><p>Ancient scrolls reveal that only the legendary "Petals of Power" can restore the Tree. These petals, once part of the Grand Tree itself, were scattered across the realm long ago, each guarded by a flora guardian known for their wisdom and cunning.</p><h3>A Call to Adventure</h3><p>Using the last remnants of its power, the Grand Tree sends out a call for help. Brave adventurers are needed to embark on an epic quest to retrieve the Petals of Power and restore vitality to the Garden Kingdom. The survival of the Garden Kingdom hangs in the balance, and so begins your saga.</p>';
            storyArea.innerHTML = storyHTML;
        }

        function startGame(isNewGame) {
            if (isNewGame) { currentLevel = 1; localStorage.removeItem('floraMysticaLevel'); localStorage.removeItem('floraMysticaScore'); updateScore(0); }
            startScreenControls.style.display = 'none';
            fetchRiddle(currentLevel);
        }

        function fetchRiddle(level) {
            isGameActive = false; storyArea.textContent = 'Loading the challenge...'; localStorage.setItem('floraMysticaLevel', level);
            riddleArea.style.display = 'none'; submitButton.style.display = 'none'; autocompleteContainer.style.display = 'none';
            fetch(`${WEB_APP_URL}?level=${level}`).then(response => response.json()).then(data => {
                if (data.error) {
                    storyArea.innerHTML = `<strong>Congratulations! You are victorious!</strong><br>With a final score of ${score}, you have saved the Garden Kingdom! üèÜ`;
                    riddleArea.style.display = 'none'; autocompleteContainer.style.display = 'none';
                    startScreenControls.innerHTML = `<button id="restart-button" class="control-button">Play Again</button>`;
                    startScreenControls.style.display = 'block';
                    document.getElementById('restart-button').addEventListener('click', () => startGame(true));
                } else {
                    storyArea.textContent = data.storyText; riddleArea.textContent = data.riddle;
                    riddleArea.style.display = 'block'; autocompleteContainer.style.display = 'inline-block'; submitButton.style.display = 'inline-block';
                    submitButton.disabled = false; answerInput.value = ''; answerInput.focus(); feedbackArea.textContent = ''; isGameActive = true;
                }
            }).catch(error => console.error('Error fetching riddle:', error));
        }
        
        function checkAnswer() {
            isGameActive = false; submitButton.disabled = true;
            const userAnswer = answerInput.value;
            if (!userAnswer) { feedbackArea.textContent = 'Please select an answer.'; isGameActive = true; submitButton.disabled = false; return; }
            autocompleteResults.style.display = 'none';
            const checkUrl = `${WEB_APP_URL}?level=${currentLevel}&check=true&answer=${encodeURIComponent(userAnswer)}`;
            fetch(checkUrl).then(response => response.json()).then(data => {
                if (data.result === 'correct') {
                    updateScore(score + 10);
                    feedbackArea.className = 'feedback-text feedback-correct';
                    feedbackArea.textContent = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
                    currentLevel++;
                    setTimeout(() => fetchRiddle(currentLevel), 2000);
                } else {
                    updateScore(score - 5);
                    feedbackArea.className = 'feedback-text feedback-incorrect';
                    feedbackArea.textContent = `ü§î Not quite. Here's a hint: ${data.hint}`;
                    isGameActive = true; submitButton.disabled = false; answerInput.focus();
                }
            }).catch(error => { console.error('Error checking answer:', error); isGameActive = true; submitButton.disabled = false; });
        }
        
        submitButton.addEventListener('click', () => { if (isGameActive) checkAnswer(); });
        answerInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && isGameActive) checkAnswer(); });
        answerInput.addEventListener('input', () => {
            const inputValue = answerInput.value; autocompleteResults.innerHTML = '';
            if (inputValue.length < 3) { autocompleteResults.style.display = 'none'; return; }
            const suggestions = plantFamilies.filter(f => f.toLowerCase().startsWith(inputValue.toLowerCase()));
            if (suggestions.length > 0) {
                suggestions.slice(0, 10).forEach(suggestion => {
                    const item = document.createElement('div'); item.textContent = suggestion;
                    item.addEventListener('click', () => { answerInput.value = suggestion; autocompleteResults.style.display = 'none'; });
                    autocompleteResults.appendChild(item);
                });
                autocompleteResults.style.display = 'block';
            } else { autocompleteResults.style.display = 'none'; }
        });
        document.addEventListener('click', (e) => { if (!autocompleteContainer.contains(e.target)) { autocompleteResults.style.display = 'none'; } });
    </script>
</body>
</html>